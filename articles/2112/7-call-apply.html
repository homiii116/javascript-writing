<h1 class="style1c">【JavaScriptの応用】thisの参照先を指定するcall/applyメソッドの使い方</h1>
<p>JavaScriptにおけるthisの値は、基本的に関数の実行時に決定します。
しかし、call/applyメソッドと使うことで、関数実行時においてthisの参照先を指定することが可能です。
今回は、thisを制御するためのcall/applyメソッドについて解説していきます。</p>
<h2 class="style2c">call/applyメソッドとは</h2>
<p>「call/applyメソッド」は、関数オブジェクトのメソッドです。
関数として定義されているものは、これらのメソッドを呼び出すことができます。</p>
<p>では、これらのメソッドを使うと、どのようなことができるのでしょうか。
それは、明示的にthisの参照先を指定して関数を実行するという点です。
一言で言えば、元のthisの値を無理やり変更することができるというイメージです。</p>
<h2 class="style2c">call/applyメソッドの使い方</h2>
<p>説明だけでは理解しにくいかもしれないので、例を参考にしながら見ていきましょう。</p>
<h3 class="style3c">基本的な振る舞い</h3>
<p>まずは、基本的な振る舞いを見てみます。
以下は、testという関数を単純に呼び出すパターンと、call/applyメソッドを呼び出したパターンです。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>function test() {
  console.log('test');
}

test(); //"test"
test.call(); //"test"
test.apply(); //"test"
</code></pre>
        </div>
        
<p>すべて同じ結果となりました。
さらにcall/applyメソッドは、関数test自身を指していることが分かります。</p>
<p>では、出力先にthisを指定し、同じように関数とメソッドの呼び出しを行うとどうでしょうか。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>function test() {
    console.log(this);
}

test(); //Window
test.call(); //Window
test.apply(); //Window
</code></pre>
        </div>
        
<p>非strictモード下のthisは、すべての関数の呼び出しパターンにおいてWindowオブジェクトを参照していることが分かります。
これだけでは、単純に関数を呼び出しているだけでthisの値を制御しているとは言えません。</p>
<p>ここでcall/applyの構文と役割をしておく必要があります。</p>
<h3 class="style3c">callメソッドの基本構文</h3>
<p>以下は、callメソッドの基本構文です。
第1引数にthisの値を指定し、第2引数以降には呼び出す関数の引数を指定します。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>関数.call(thisの値, ...関数の引数);
</code></pre>
        </div>
        
<h3 class="style3c">applyメソッドの基本構文</h3>
<p>以下は、applyメソッドの基本構文です。
第1引数にthisの値を指定し、第2引数には関数の引数を配列として指定します。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>関数.apply(thisの値, [関数の引数]);
</code></pre>
        </div>
        
<h3 class="style3c">call/applyメソッドの役割</h3>
<p>つぎに、call/applyメソッドに引数を入れて動きを見てみましょう。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>let user = {name: 'World'};

function greeting(message) {
    return `${message}, ${this.name}!`;
}

//callメソッド
const call = greeting.call(user, 'Hello');
console.log(call); //"Hello World!"

//applyメソッド
const apply = greeting.apply(user, ['Nice to meet you']);
console.log(apply); //"Nice to meet you, World!"
</code></pre>
        </div>
        
<p>callメソッドの第1引数にthisの値としてuserオブジェクトを指定し、関数greetingを呼び出しています。
また、第2引数に指定した'Hello'が関数greetingの引数messageに入っていることが分かります。</p>
<p>applyメソッドも同様です。
applyメソッドの第1引数にthisの値としてuserオブジェクトを指定した状態で関数greetingを呼び出しています。
また、applyメソッドの第2引数に指定した配列['Nice to meet you']は、関数が呼ばれると自動的に中身が展開され、関数greetingの引数messageに入ります。</p>
<p>補足ですが、thisが必要ない場合には、第1引数にnullを渡すのが一般的です。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>function greeting(message) {
    return message;
}

const call = greeting.call(null, 'Hello');
console.log(call); //"Hello"

const apply = greeting.apply(null, ['Nice to meet you']);
console.log(apply);//"Nice to meet you"
</code></pre>
        </div>
        
<p>いかがでしょうか。
call/applyメソッドは、通常関数の呼び出し先によって決定されるthisの値を、明示的に指定することができ、それによって関数やメソッドを別のオブジェクトに割り当てることができます。</p>
<h2 class="style2c">call/applyメソッドの違い</h2>
<p>call/applyメソッドはほとんど同じ動きをしますが、違いもあります。
それは、関数の引数への値の渡し方です。</p>

        <div class="hcb_wrap">
        <pre class="prism undefined-numbers lang-js" data-lang="JavaScript"><code>let user = {name: '太郎'};

function add(a, b) {
    return `${this.name}のスコアの合計は${a + b}です`;
}

//パターン1
console.log(add.call(user, 10, 20)); //"太郎のスコアの合計は30です"
console.log(add.apply(user, [30, 40])); //"太郎のスコアの合計は70です"

//パターン2
let score1 = {a: 10, b: 20}
let score2 = [30, 40];
console.log(add.call(user, score1.a, score1.b)); //"太郎のスコアの合計は30です"
console.log(add.apply(user, score2)); //"太郎のスコアの合計は70です"
</code></pre>
        </div>
        
<p>上記のように、callメソッドは、第2引数以降をそのまま指定するのに対し、applyメソッドは、第2引数を配列に入れて指定する点が異なります。</p>
<h2 class="style2c">まとめ</h2>
<p>今回は、call/applyメソッドについて解説しました。</p>
<p>thisの振る舞いを理解していればthisの挙動を予想することができます。
しかし、thisの値を指定しておきたい場合や、予期しないthisの挙動を発生させないためにも、call/applyメソッドを知っておくと役に立ちます。</p>
<p>初心者がつまづきやすいと言われるthisですが、これらのメソッドを使いながら理解を深めていきましょう。</p>
<h3 class="style3c">JavaScript関連記事</h3>
<p>[clink url="https://tcd-theme.com/2021/12/javascript-this.html"]</p>


