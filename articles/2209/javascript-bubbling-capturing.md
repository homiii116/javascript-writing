# 【JavaScriptの基本】バブリングとキャプチャリング

イベントは一つの要素のみで発生しているわけではありません。
イベントが発生する時、きっかけとなる要素から他の要素にも伝搬していくような仕組みになっています。

今回は、イベント伝搬に重要なバブリングとキャプチャリングの仕組みについて解説していきます。

## イベント伝搬
イベント伝搬とは、ある要素からイベントが伝わり広がっていくことです。
イベントがどこかの要素で発生すると、その要素から他の要素へとイベントが伝搬していきます。

イベント伝搬は、以下の3つのフェーズの道筋を通ります。

1. キャプチャリングフェーズ：Windowオブジェクトから子の要素に下りていくフェーズ
2. ターゲットフェーズ：イベントが発生した要素に到達するフェーズ
3. バブリングフェーズ：イベントが発生した要素から親要素に上っていくフェーズ

例えば、以下のHTMLドキュメントがあるとします。
```html
<html>
<head></head>
<body>
  <h1>イベントの伝搬</h1>
  <div>
    <input id="elem" type="button" value="button">
  </div>
</body>
</html>
```
このHTMLページにある"button"がクリックされた時、イベントはこのような流れで伝搬していきます。

** event-phase **

```input```をクリックした場合、イベントは一番トップにある```Window```から下りていき（キャプチャリング）、ターゲットである```input```に到達します。
到達後、ハンドラを呼び出しながら```Window```を目掛けて上っていきます（バブリング）。

フェーズごとに詳しく見ていきましょう。

## バブリング
バブリングはイベント伝搬としては最後のフェーズですが、特に重要なフェーズのため先に解説をします。

バブリングは、ある要素のイベントが発生すると、はじめにその要素のハンドラが実行され、次に親要素、さらにその上の親要素へイベントが伝搬されていきます。
そのため、ターゲット要素の祖先である要素もバブリングフェーズによってイベントが発生し、登録されているハンドラが呼び出されます。

例えば、以下のように```section > div > p```それぞれの要素にハンドラが登録されているとします。
```html
<style>
  body {
    width: 740px;
  }

  section,section div,p {
    border: 2px solid blue;
    margin: 5px;
    padding: 5px;
  }
</style>

<h1>バブリング</h1>
<section onclick="console.log('section')">section
  <div onclick="console.log('div')">div
    <p onclick="console.log('p')">p</p>
  </div>
</section>
 ```

** bubbling_1 ** 

```<p>```をクリックしてみます。
** bubbling_2 **

すると、各要素に登録されているハンドラが呼び出され、"p" → "div" → "section"の順番で出力されていることが分かります。

しかし、実際にクリックされた```<p>```なら分かりますが、なぜ```<div>```と```<section>```までハンドラが実行されたのでしょうか？
それは、```<p>```で発生したクリックイベントが```<div>```に渡り、その後```<section>```、そして```document```まで渡っているからです。

では、次に```<div>```をクリックしてみます。
** bubbling_3 **

今度はイベントが発生した```<div>```から```<section>```に渡るため、出力されるのは"div"と"section"になります。

このように、イベント発生源の要素から上に向かってイベントが水の泡のように伝わっていくことからバブリングと表現されます。

## ターゲット
キャプチャリングフェーズの後、実際にイベントが発生した要素にイベントが到達した段階のことをターゲットフェーズと呼びます。
実際にイベントが発生した要素は、もっとも階層が深い位置にいます。この要素のことをターゲット要素と呼びます。

ターゲットフェーズでイベントが発生すると、ターゲット要素に登録されているハンドラが呼び出されます。

ターゲット要素は、```event.target```でアクセスすることが可能です。
```html
<style>
  body {
    width: 740px;
  }

  section,section div,p {
    border: 2px solid blue;
    margin: 5px;
    padding: 5px;
  }
</style>

<h1>ターゲット</h1>
<section>section
  <div>div
    <p>p</p>
  </div>
</section>

<script>
  document.onclick = function(event) {
    // ターゲット要素のタグ名を出力
    console.log(event.target.tagName);
  };
</script>
 ```

```<div>```をクリックすると、このように"DIV"のみが出力されるはずです。
** target **

## キャプチャリング
イベント発生後、Documentオブジェクトからターゲット要素まで下へ向かってイベントが流れてくるフェーズをキャプチャリングフェーズと呼びます。

実際には、キャプチャリングフェーズの際に発生したイベントはほとんど使われないため、あまり重要なフェーズではありません。上述したバブリングフェーズやイベントフェーズの方が影響があります。
